name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        id: build
        run: |
          set +e
          npm run build -- --verbose 2>&1 | tee build_output.txt
          BUILD_EXIT=$?
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "## Build Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 build_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit $BUILD_EXIT
          fi

      - name: Generate TTS audio
        run: |
          pip3 install edge-tts --quiet
          python3 << 'PYEOF'
          import asyncio, re, sys
          from pathlib import Path
          import edge_tts
          POSTS_DIR = Path("_posts")
          AUDIO_DIR = Path("dist/assets/audio")
          VOICE = "en-US-AriaNeural"
          MARKER = "<!-- nb-audio-player -->"
          TPL = '<div id="nbp-{s}" style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:10px;padding:12px 16px;margin:0 0 24px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;display:flex;align-items:center;gap:12px;"><button id="nbb-{s}" style="background:#0d6efd;border:none;border-radius:50%;width:44px;height:44px;cursor:pointer;flex-shrink:0;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;" aria-label="Play">&#9654;</button><div style="flex:1;min-width:0;"><div style="font-size:12px;color:#6c757d;margin-bottom:4px;font-weight:600;letter-spacing:.3px;">&#127908; Listen to this brief</div><input type="range" id="nbs-{s}" value="0" min="0" max="100" step="0.1" style="width:100%;height:4px;cursor:pointer;accent-color:#0d6efd;" aria-label="Seek"><div style="font-size:11px;color:#adb5bd;margin-top:4px;"><span id="nbc-{s}">0:00</span>&thinsp;/&thinsp;<span id="nbd-{s}">--:--</span></div></div><audio id="nba-{s}" src="/assets/audio/{s}.mp3" preload="metadata"></audio></div><script>(function(){var s="{s}";var a=document.getElementById("nba-"+s);var b=document.getElementById("nbb-"+s);var sk=document.getElementById("nbs-"+s);var cu=document.getElementById("nbc-"+s);var du=document.getElementById("nbd-"+s);function fmt(n){var m=Math.floor(n/60),q=Math.floor(n%60);return m+":"+(q<10?"0":"")+q;}b.addEventListener("click",function(){if(a.paused){a.play();b.innerHTML="&#9646;&#9646;";b.setAttribute("aria-label","Pause");}else{a.pause();b.innerHTML="&#9654;";b.setAttribute("aria-label","Play");}});sk.addEventListener("input",function(){if(a.duration)a.currentTime=(parseFloat(sk.value)/100)*a.duration;});a.addEventListener("ended",function(){b.innerHTML="&#9654;";b.setAttribute("aria-label","Play");sk.value=0;});a.addEventListener("timeupdate",function(){if(a.duration){sk.value=(a.currentTime/a.duration)*100;cu.textContent=fmt(a.currentTime);}});a.addEventListener("loadedmetadata",function(){du.textContent=fmt(a.duration);});})();</script>'
          def find_latest():
              # Search for the latest news brief in both the legacy POSTS_DIR
              # (e.g., "_posts") and the actual content directory where posts
              # are stored (site/content/newsfeed/).
              search_dirs = []
              if POSTS_DIR.exists():
                  search_dirs.append(POSTS_DIR)
              alt_dir = POSTS_DIR.parent / "site" / "content" / "newsfeed"
              if alt_dir.exists():
                  search_dirs.append(alt_dir)
              posts = []
              for d in search_dirs:
                  posts.extend(d.glob("*-news-brief.md"))
              posts = sorted(posts, reverse=True)
              return posts[0] if posts else None
          def parse_post(p):
              t = p.read_text(encoding="utf-8")
              # Be tolerant of different line endings and normalize known front matter keys.
              m = re.match(r"^---\r?\n(.*?)\r?\n---\r?\n?(.*)", t, re.DOTALL)
              if not m:
                  return ("", t)
              front, body = m.group(1), m.group(2)
              # Normalize pubDate -> date to match downstream expectations.
              front = re.sub(r'(?m)^pubDate\s*:', 'date:', front)
              return (front, body)
          def extract_headlines(body):
              hl = []
              in_hl = False
              for line in body.splitlines():
                  if line.startswith("#") and "highlight" in line.lower():
                      in_hl = True
                      continue
                  if in_hl:
                      if line.startswith("#"):
                          break
                      # First, handle numbered bold headlines like:
                      # "1. **Key Threat Intel & Vulnerability Stories** (14 mentions)"
                      m = re.search(r'^\s*\d+\.\s+\*\*(.+?)\*\*', line)
                      if not m:
                          # Fallback to existing link-based extraction for older formats
                          m = re.search(r'<a[^>]*>([^<]+)</a>', line)
                      if not m:
                          m = re.search(r'\[([^\]]+)\]\(', line)
                      if m:
                          hl.append(m.group(1).strip())
              return hl
          def build_script(title, headlines):
              parts = ["Weekly News Brief. " + title + "."]
              if headlines:
                  parts.append("Here are the top headlines.")
                  for i, h in enumerate(headlines, 1):
                      parts.append("Headline " + str(i) + ". " + h + ".")
              parts.append("That is all for this week. Stay informed.")
              return " ".join(parts)
          async def gen_audio(text, path):
              c = edge_tts.Communicate(text, VOICE)
              await c.save(str(path))
          def main():
              post = find_latest()
              if not post:
                  print("No newsbrief post found, skipping TTS.")
                  return
              stem = post.stem
              fm, body = parse_post(post)
              if MARKER in body:
                  print("Player already present in " + stem + ", skipping.")
                  return
              hl = extract_headlines(body)
              if not hl:
                  print("No highlights found in " + stem + ", skipping TTS.")
                  return
              tm = re.search(r"^title:\s*(.+)$", fm, re.MULTILINE)
              title = tm.group(1).strip().strip("\"'") if tm else "Weekly News Brief"
              AUDIO_DIR.mkdir(parents=True, exist_ok=True)
              ap = AUDIO_DIR / (stem + ".mp3")
              asyncio.run(gen_audio(build_script(title, hl), ap))
              print("Audio generated: " + str(ap))
              ph = TPL.replace("{s}", stem)
              post.write_text(
                  "---\n" + fm + "\n---\n" + MARKER + "\n" + ph + "\n\n" + body,
                  encoding="utf-8"
              )
              print("Player injected into " + str(post))
          main()
          PYEOF
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
